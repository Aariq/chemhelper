---
title: "Webscrping retention indices"
output: html_notebook
---

# Webscraping retention indices
My plan is to eventually make this part of `webchem`, but for now I'll work on this notebook as part of the `chemhelper` project so I can more easily play around with development versions on my own.

The goal is to look up RI's given an input of CAS numbers (or other inputs in the future).  The function will **require** an argument for the type of index (kovats, normal aklane, van den dool and kratz), the colum polarity, and the temperature program (isothermal, ramp, custom).  These arguments will be required because each is a separate table, and why would you ever want all of them?  I might just leave it at that and download the whole table and then let people do filtering with `tidyverse` functions.  I could include optional arguments to filter by certain column types, column dimensions, etc.

# Required packages
Could probably avoid `stringr` if `webchem` doesn't want to import it
```{r}
library(tidyverse)
library(stringr)
```

```{r}
library(rvest)
#create function to read_html slowly to avoid getting banned
read_html_slow <- function(x, ...){
  output <- read_html(x)
  Sys.sleep(5)
  return(output)
}

read_html_safely <- possibly(read_html_slow, NA)
```

# making URLs
Detailed table URLs

RI types:

- Kovats = KOVATS-RI
- Van den Dool and Kratz = LINEAR-RI
- Normal alkane = ALKANE-RI

Polarity: 

- NON-POLAR
- POLAR

Temperature Programs:

- RAMP
- ISOTHERMAL
- CUSTOM

# Make a function for getting URL
```{r}
RItableURL <- function(cas, type = c("kovats", "linear", "alkane"), polarity = c("polar", "non-polar"), temp_prog = c("isothermal", "ramp", "custom")){
  type_str <- toupper(paste(type, "RI", polarity, temp_prog, sep = "-"))
  URL_detail <- paste0("https://webbook.nist.gov/cgi/cbook.cgi?ID=C",
                       str_remove_all(cas, "-"),
                       "&Units=SI&Mask=2000&Type=",
                       type_str)
  return(URL_detail)
}

URL_detail <- RItableURL("78-70-6", "alkane", "non-polar", "custom")
URL_detail2 <- RItableURL("53834-70-1", "linear", "polar", "ramp")
```
```{r}
get_RI_tables <- function(cas, type = c("kovats", "linear", "alkane"), polarity = c("polar", "non-polar"), temp_prog = c("isothermal", "ramp", "custom")){
  type_str <- toupper(paste(type, "RI", polarity, temp_prog, sep = "-"))
  URL_detail <- paste0("https://webbook.nist.gov/cgi/cbook.cgi?ID=C",
                       str_remove_all(cas, "-"),
                       "&Units=SI&Mask=2000&Type=",
                       type_str)
  page <- read_html_safely(URL_detail)
  tables <- html_nodes(page, ".data")
  attr(tables, "type") <- type
  attr(tables, "polarity") <- polarity
  attr(tables, "temp_prog") <- temp_prog
  return(tables)
}

test <- get_RI_tables("78-70-6", "alkane", "non-polar", "custom")
test2 <- get_RI_tables("78-70-6", "alkane", "non-polar", "ramp")
```
```{r}
 tidy1 <- test2 %>%
    #transpose tables and fix column names
  map({
  . %>% 
    html_table() %>% 
    t() %>%
    as.data.frame(stringsAsFactors = FALSE) %>% 
    setNames(.[1, ]) %>% 
    slice(-1)
}) %>%
    # bind into one table
  bind_rows()
tidy1

tidy1 %>% rename(type = "Column type",
         phase = "Active phase",
         length = "Column length (m)",
         gas = "Carrier gas",
         substrate = "Substrate",
         diameter = "Column diameter (mm)",
         thickness = "Phase thickness (m)",
         T_start = "Tstart (C)",
         T_end - "Tend (C)",
         
         RI = "I",
         reference = "Reference",
         comment = "Comment") %>% 
    # fix column types and make uniform contents of some columns
  mutate_at(vars(length, diameter, thickness, RI), as.numeric)
```



# Combine all tidying steps into one function
```{r}
columns_custom <- function(table){
  table %>% rename(type = "Column type",
         phase = "Active phase",
         length = "Column length (m)",
         gas = "Carrier gas",
         substrate = "Substrate",
         diameter = "Column diameter (mm)",
         thickness = "Phase thickness (m)",
         program = "Program",
         RI = "I",
         reference = "Reference",
         comment = "Comment") %>% 
    # fix column types and make uniform contents of some columns
  mutate_at(vars(length, diameter, thickness, RI), as.numeric)
}

columns_ramp

columns_iso

tidy_RItable <- function(tables){
  
  temp_prog <- attr(tables, "temp_prog")
  
  tidy1 <- tables %>%
    #transpose tables and fix column names
  map({
  . %>% 
    html_table() %>% 
    t() %>%
    as.data.frame(stringsAsFactors = FALSE) %>% 
    setNames(.[1, ]) %>% 
    slice(-1)
}) %>%
    # bind into one table
  bind_rows()
  if(temp_prog == "custom"){
    tidy2 <- columns_custom(tidy1)
  } else if(temp_prog == "ramp"){
    tidy2 <- columns_ramp(tidy1)
  } else if(temp_prog == "isothermal"){
    tidy2 <- columns_iso(tidy1)
  }
  
  # fix column names %>% 
  output <- tidy2 %>%
    mutate_all(~na_if(., "")) %>%
    mutate(gas = case_when(
      str_detect(gas, "He") ~ "Helium",
      str_detect(gas, "H2") ~ "Hydrogen",
      str_detect(gas, "N2") ~ "Nitrogen",
      TRUE                  ~ as.character(NA)
    )) %>%
    # reorder columns
    select(type, phase, RI, everything())
  return(output)
}
tidy_RItable(tables)
```

# Now test on multiple tables

```{r}
tables
tables2 <- tidy_RItable(tables2)
```

